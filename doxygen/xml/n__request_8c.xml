<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.1" xml:lang="en-US">
  <compounddef id="n__request_8c" kind="file" language="C++">
    <compoundname>n_request.c</compoundname>
    <includes local="yes">n_lib.h</includes>
    <incdepgraph>
      <node id="1">
        <label>/home/runner/work/note-c/note-c/n_request.c</label>
        <link refid="n__request_8c"/>
        <childnode refid="2" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>n_lib.h</label>
      </node>
    </incdepgraph>
      <sectiondef kind="define">
      <memberdef kind="define" id="n__request_8c_1af118c2aba9040de625bebcf41c49e571" prot="public" static="no">
        <name>NOTE_C_STATIC</name>
        <initializer>static</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="18" column="10" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="18" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="n__request_8c_1a8334a93acebb34e7bc188f767dc42f90" prot="public" static="no">
        <name>CRC_FIELD_LENGTH</name>
        <initializer>22</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="30" column="9" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="30" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="n__request_8c_1a370d78366b4c13731108b1afd745b4ce" prot="public" static="no">
        <name>CRC_FIELD_NAME_OFFSET</name>
        <initializer>1</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="31" column="9" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="31" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="n__request_8c_1ac5f2372cc25a915c8dccd2924c7c6f19" prot="public" static="no">
        <name>CRC_FIELD_NAME_TEST</name>
        <initializer>&quot;\&quot;crc\&quot;:\&quot;&quot;</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="32" column="9" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="32" bodyend="-1"/>
      </memberdef>
      </sectiondef>
      <sectiondef kind="var">
      <memberdef kind="variable" id="n__request_8c_1aebcf84f5111ed46b77b211518ede072b" prot="public" static="yes" mutable="no">
        <type>int</type>
        <definition>int suppressShowTransactions</definition>
        <argsstring></argsstring>
        <name>suppressShowTransactions</name>
        <initializer>= 0</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="22" column="12" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="22" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="n__request_8c_1ac1d3a148b17a5684b5220cc6c79fbb17" prot="public" static="yes" mutable="no">
        <type>bool</type>
        <definition>bool resetRequired</definition>
        <argsstring></argsstring>
        <name>resetRequired</name>
        <initializer>= true</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="25" column="13" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="25" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="n__request_8c_1a8e266f32498ed44f49938ceeda8ca985" prot="public" static="yes" mutable="no">
        <type>uint16_t</type>
        <definition>uint16_t lastRequestSeqno</definition>
        <argsstring></argsstring>
        <name>lastRequestSeqno</name>
        <initializer>= 0</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="29" column="17" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="29" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="n__request_8c_1afd1a66fac337acafa89c520e8c72020d" prot="public" static="yes" mutable="no">
        <type>bool</type>
        <definition>bool notecardSupportsCrc</definition>
        <argsstring></argsstring>
        <name>notecardSupportsCrc</name>
        <initializer>= false</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="37" column="13" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="37" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="n__request_8c_1aa4c319e0c579ff559958558f469b6ea7" prot="public" static="yes" mutable="no">
        <type>uint32_t</type>
        <definition>uint32_t lut[16]</definition>
        <argsstring>[16]</argsstring>
        <name>lut</name>
        <initializer>= {
    0x00000000, 0x1DB71064, 0x3B6E20C8, 0x26D930AC, 0x76DC4190, 0x6B6B51F4,
    0x4DB26158, 0x5005713C, 0xEDB88320, 0xF00F9344, 0xD6D6A3E8, 0xCB61B38C,
    0x9B64C2B0, 0x86D3D2D4, 0xA00AE278, 0xBDBDF21C
}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="761" column="17" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="761" bodyend="-1"/>
      </memberdef>
      </sectiondef>
      <sectiondef kind="func">
      <memberdef kind="function" id="n__request_8c_1ab5b1e4d577087741cdb72d053862b5c7" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int32_t</type>
        <definition>static int32_t crc32</definition>
        <argsstring>(const void *data, size_t length)</argsstring>
        <name>crc32</name>
        <param>
          <type>const void *</type>
          <declname>data</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>length</declname>
        </param>
        <briefdescription>
<para>Compute the CRC32 of the passed in buffer. </para>
        </briefdescription>
        <detaileddescription>
<para>Small lookup-table half-byte CRC32 algorithm. See <ulink url="https://create.stephan-brumme.com/crc32/#half-byte">https://create.stephan-brumme.com/crc32/#half-byte</ulink></para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>data</parametername>
</parameternamelist>
<parameterdescription>
<para>The buffer. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>length</parametername>
</parameternamelist>
<parameterdescription>
<para>The length of the buffer.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>The CRC32 of the buffer. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="778" column="16" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="778" bodyend="789" declfile="/home/runner/work/note-c/note-c/n_request.c" declline="33" declcolumn="16"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1aca42f95fc4fece91b6e0aa38c0886dea" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>char *</type>
        <definition>static char * crcAdd</definition>
        <argsstring>(char *json, uint16_t seqno)</argsstring>
        <name>crcAdd</name>
        <param>
          <type>char *</type>
          <declname>json</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>seqno</declname>
        </param>
        <briefdescription>
<para>Append a &quot;crc&quot; field to the passed in JSON buffer. </para>
        </briefdescription>
        <detaileddescription>
<para>The &quot;crc&quot; field has a value of the form &quot;SSSS:CCCCCCCC&quot;, where SSSS is the passed in sequence number and CCCCCCCC is the CRC32.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>json</parametername>
</parameternamelist>
<parameterdescription>
<para>The JSON buffer to both add the CRC32 to and to compute the CRC32 over. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>seqno</parametername>
</parameternamelist>
<parameterdescription>
<para>A 16-bit sequence number to include as a part of the CRC.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>A dynamically-allocated version of the passed in buffer with the CRC field added or NULL on error. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="804" column="13" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="804" bodyend="844" declfile="/home/runner/work/note-c/note-c/n_request.c" declline="34" declcolumn="14"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a46a3345cb3a69deb698730ac50eaf70d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool crcError</definition>
        <argsstring>(char *json, uint16_t shouldBeSeqno)</argsstring>
        <name>crcError</name>
        <param>
          <type>char *</type>
          <declname>json</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>shouldBeSeqno</declname>
        </param>
        <briefdescription>
<para>Check the passed in JSON for CRC and sequence number errors. </para>
        </briefdescription>
        <detaileddescription>
<para>If the calculated CRC32 doesn&apos;t match what&apos;s in the buffer, that&apos;s an error. If the sequence number in the buffer doesn&apos;t match shouldBeSeqno, that&apos;s an error. If there is no CRC field in the buffer, that&apos;s not an error UNLESS this function has been given a buffer with a CRC field before. In this case, the lack of a CRC field is an error.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>json</parametername>
</parameternamelist>
<parameterdescription>
<para>The JSON buffer for which the CRC should be checked. Note that the CRC is stripped from the input JSON regardless of whether or not there was an error. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>shouldBeSeqno</parametername>
</parameternamelist>
<parameterdescription>
<para>The expected sequence number.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para><computeroutput>true</computeroutput> if there&apos;s an error and <computeroutput>false</computeroutput> otherwise. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="862" column="13" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="862" bodyend="888" declfile="/home/runner/work/note-c/note-c/n_request.c" declline="35" declcolumn="13"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a444d6ac5c0452ecbfd4f9ff11712f95e" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="struct_j" kindref="compound">J</ref> *</type>
        <definition>static J* errDoc</definition>
        <argsstring>(const char *errmsg)</argsstring>
        <name>errDoc</name>
        <param>
          <type>const char *</type>
          <declname>errmsg</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="52" column="11" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="52" bodyend="68"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1ab0427f0cd3e286d8020309ea88687d09" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void NoteSuspendTransactionDebug</definition>
        <argsstring>(void)</argsstring>
        <name>NoteSuspendTransactionDebug</name>
        <param>
          <type>void</type>
        </param>
        <briefdescription>
<para>Suppress showing transaction details. </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="73" column="6" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="73" bodyend="76"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a27085ec262c1b7e69d4f8998e2a5219c" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void NoteResumeTransactionDebug</definition>
        <argsstring>(void)</argsstring>
        <name>NoteResumeTransactionDebug</name>
        <param>
          <type>void</type>
        </param>
        <briefdescription>
<para>Resume showing transaction details. </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="81" column="6" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="81" bodyend="84"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a2f5fce48cfd817f1bf940ab145f7cc59" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="struct_j" kindref="compound">J</ref> *</type>
        <definition>J* NoteNewRequest</definition>
        <argsstring>(const char *request)</argsstring>
        <name>NoteNewRequest</name>
        <param>
          <type>const char *</type>
          <declname>request</declname>
        </param>
        <briefdescription>
<para>Create a new JSON request. </para>
        </briefdescription>
        <detaileddescription>
<para>Creates a dynamically allocated <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> object with one field <computeroutput>&quot;req&quot;</computeroutput> whose value is the passed in request string.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>request</parametername>
</parameternamelist>
<parameterdescription>
<para>The name of the request, for example <computeroutput>hub.set</computeroutput>.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>A <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> object with the &quot;req&quot; field populated. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="96" column="3" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="96" bodyend="103"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a48877576f8d94864dedbe663ba68c3f0" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="struct_j" kindref="compound">J</ref> *</type>
        <definition>J* NoteNewCommand</definition>
        <argsstring>(const char *request)</argsstring>
        <name>NoteNewCommand</name>
        <param>
          <type>const char *</type>
          <declname>request</declname>
        </param>
        <briefdescription>
<para>Create a new JSON command. </para>
        </briefdescription>
        <detaileddescription>
<para>Create a dynamically allocated <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> object with one field <computeroutput>&quot;cmd&quot;</computeroutput> whose value is the passed in request string. The difference between a command and a request is that the Notecard does not send a response to commands, only to requests.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>request</parametername>
</parameternamelist>
<parameterdescription>
<para>The name of the command (e.g. <computeroutput>card.attn</computeroutput>).</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>A <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> object with the &quot;cmd&quot; field populated. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="117" column="3" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="117" bodyend="124"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1ab1227db7501f0b979ed894fb764790e3" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool NoteRequest</definition>
        <argsstring>(J *req)</argsstring>
        <name>NoteRequest</name>
        <param>
          <type><ref refid="struct_j" kindref="compound">J</ref> *</type>
          <declname>req</declname>
        </param>
        <briefdescription>
<para>Send a request to the Notecard. </para>
        </briefdescription>
        <detaileddescription>
<para>The passed in request object is always freed, regardless of if the request was successful or not. The response from the Notecard, if any, is freed and not returned to the caller.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>req</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to a <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> request object.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para><computeroutput>true</computeroutput> if successful and <computeroutput>false</computeroutput> if an error occurs (e.g. out of memory or the response from the Notecard has an &quot;err&quot; field). If req is a command rather than a request, a <computeroutput>true</computeroutput> return value indicates that the command was sent without error. However, since the Notecard sends no response to commands, it does not guarantee that the command was received and processed by the Notecard.</para>
</simplesect>
<simplesect kind="see"><para><computeroutput><ref refid="n__request_8c_1ab163a75667bef7e74294125d40e15c12" kindref="member">NoteRequestResponse</ref></computeroutput> if you need to work with the response. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="144" column="6" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="144" bodyend="156"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a7eef6ff395f1e94934d3f9eb99bbcb9a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool NoteRequestWithRetry</definition>
        <argsstring>(J *req, uint32_t timeoutSeconds)</argsstring>
        <name>NoteRequestWithRetry</name>
        <param>
          <type><ref refid="struct_j" kindref="compound">J</ref> *</type>
          <declname>req</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>timeoutSeconds</declname>
        </param>
        <briefdescription>
<para>Send a request to the Notecard, retrying it until it succeeds or it times out. </para>
        </briefdescription>
        <detaileddescription>
<para>The passed in request object is always freed, regardless of if the request was successful or not. The response from the Notecard, if any, is freed and not returned to the caller.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>req</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to a <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> request object. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>timeoutSeconds</parametername>
</parameternamelist>
<parameterdescription>
<para>Time limit for retires, in seconds, if there is no response, or if the response contains an I/O error.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para><computeroutput>true</computeroutput> if successful and <computeroutput>false</computeroutput> if an error occurs (e.g. out of memory or the response from the Notecard has an &quot;err&quot; field).</para>
</simplesect>
<simplesect kind="see"><para><computeroutput><ref refid="n__request_8c_1a5d43b857b1bf72f312a2e7ba1825445b" kindref="member">NoteRequestResponseWithRetry</ref></computeroutput> if you need to work with the response. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="175" column="6" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="175" bodyend="188"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1ab163a75667bef7e74294125d40e15c12" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="struct_j" kindref="compound">J</ref> *</type>
        <definition>J* NoteRequestResponse</definition>
        <argsstring>(J *req)</argsstring>
        <name>NoteRequestResponse</name>
        <param>
          <type><ref refid="struct_j" kindref="compound">J</ref> *</type>
          <declname>req</declname>
        </param>
        <briefdescription>
<para>Send a request to the Notecard and return the response. </para>
        </briefdescription>
        <detaileddescription>
<para>The passed in request object is always freed, regardless of if the request was successful or not.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>req</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to a <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> request object.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>A <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> object with the response or NULL if there was an error sending the request.</para>
</simplesect>
<simplesect kind="see"><para><computeroutput><ref refid="note_8h_1acd6f73358d95a8188495babd142c5977" kindref="member">NoteResponseError</ref></computeroutput> to check the response for errors. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="203" column="3" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="203" bodyend="219"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a5d43b857b1bf72f312a2e7ba1825445b" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="struct_j" kindref="compound">J</ref> *</type>
        <definition>J* NoteRequestResponseWithRetry</definition>
        <argsstring>(J *req, uint32_t timeoutSeconds)</argsstring>
        <name>NoteRequestResponseWithRetry</name>
        <param>
          <type><ref refid="struct_j" kindref="compound">J</ref> *</type>
          <declname>req</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>timeoutSeconds</declname>
        </param>
        <briefdescription>
<para>Send a request to the Notecard, retrying it until it succeeds or it times out, and return the response. </para>
        </briefdescription>
        <detaileddescription>
<para>The passed in request object is always freed, regardless of if the request was successful or not.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>req</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to a <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> request object. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>timeoutSeconds</parametername>
</parameternamelist>
<parameterdescription>
<para>Time limit for retires, in seconds, if there is no response, or if the response contains an I/O error.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>A <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> object with the response or NULL if there was an error sending the request.</para>
</simplesect>
<simplesect kind="see"><para><computeroutput><ref refid="note_8h_1acd6f73358d95a8188495babd142c5977" kindref="member">NoteResponseError</ref></computeroutput> to check the response for errors. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="237" column="3" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="237" bodyend="284"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a24fcc50f78212b5f7e08ed05b58c0ad1" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>char *</type>
        <definition>char* NoteRequestResponseJSON</definition>
        <argsstring>(const char *reqJSON)</argsstring>
        <name>NoteRequestResponseJSON</name>
        <param>
          <type>const char *</type>
          <declname>reqJSON</declname>
        </param>
        <briefdescription>
<para>Send a request to the Notecard and return the response. </para>
        </briefdescription>
        <detaileddescription>
<para>Unlike <computeroutput>NoteRequestResponse</computeroutput>, this function expects the request to be a valid JSON C-string, rather than a <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> object. This string MUST be newline-terminated. The response is returned as a dynamically allocated JSON C-string. The response string is verbatim what was sent by the Notecard, which IS newline-terminated. The caller is responsible for freeing the response string. If the request was a command (i.e. it uses &quot;cmd&quot; instead of &quot;req&quot;), this function returns NULL, because the Notecard does not send a response to commands.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>reqJSON</parametername>
</parameternamelist>
<parameterdescription>
<para>A valid newline-terminated JSON C-string containing the request.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>A newline-terminated JSON C-string with the response, or NULL if there was no response or if there was an error.</para>
</simplesect>
<simplesect kind="note"><para>When a &quot;cmd&quot; is sent, it is not possible to determine if an error occurred. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="304" column="7" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="304" bodyend="359"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a8b5e380054a80026a80c531a734f025c" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="struct_j" kindref="compound">J</ref> *</type>
        <definition>J* NoteTransaction</definition>
        <argsstring>(J *req)</argsstring>
        <name>NoteTransaction</name>
        <param>
          <type><ref refid="struct_j" kindref="compound">J</ref> *</type>
          <declname>req</declname>
        </param>
        <briefdescription>
<para>Send a request to the Notecard and return the response. </para>
        </briefdescription>
        <detaileddescription>
<para>This function doesn&apos;t free the passed in request object. The caller is responsible for freeing it.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>req</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to a <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> request object.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>A <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> object with the response or NULL if there was an error sending the request.</para>
</simplesect>
<simplesect kind="see"><para><computeroutput><ref refid="note_8h_1acd6f73358d95a8188495babd142c5977" kindref="member">NoteResponseError</ref></computeroutput> to check the response for errors. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="374" column="3" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="374" bodyend="377"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1ad807b7de69820e7c5f308f8caba96562" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="struct_j" kindref="compound">J</ref> *</type>
        <definition>J* noteTransactionShouldLock</definition>
        <argsstring>(J *req, bool lockNotecard)</argsstring>
        <name>noteTransactionShouldLock</name>
        <param>
          <type><ref refid="struct_j" kindref="compound">J</ref> *</type>
          <declname>req</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>lockNotecard</declname>
        </param>
        <briefdescription>
<para>Same as <computeroutput>NoteTransaction</computeroutput>, but takes an additional parameter that indicates if the Notecard should be locked. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>req</parametername>
</parameternamelist>
<parameterdescription>
<para>The <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> cJSON request object. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>lockNotecard</parametername>
</parameternamelist>
<parameterdescription>
<para>Set to <computeroutput>true</computeroutput> if the Notecard should be locked and <computeroutput>false</computeroutput> otherwise. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>a <computeroutput><ref refid="struct_j" kindref="compound">J</ref></computeroutput> cJSON object with the response, or NULL if there is insufficient memory. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="391" column="3" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="391" bodyend="656"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a6c62afa66443f9dbb0a36bf9f76e9896" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void NoteResetRequired</definition>
        <argsstring>(void)</argsstring>
        <name>NoteResetRequired</name>
        <param>
          <type>void</type>
        </param>
        <briefdescription>
<para>Mark that a reset will be required before doing further I/O on a given port. </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="662" column="6" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="662" bodyend="665"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a6358096b5a9e5c69a4f56b12e80092fa" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool NoteReset</definition>
        <argsstring>(void)</argsstring>
        <name>NoteReset</name>
        <param>
          <type>void</type>
        </param>
        <briefdescription>
<para>Initialize or re-initialize the module. </para>
        </briefdescription>
        <detaileddescription>
<para><simplesect kind="return"><para>True if the reset was successful and false if not. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="672" column="6" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="672" bodyend="678"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a1385294098059d94d366e2fd843358e5" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool NoteErrorContains</definition>
        <argsstring>(const char *errstr, const char *errtype)</argsstring>
        <name>NoteErrorContains</name>
        <param>
          <type>const char *</type>
          <declname>errstr</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>errtype</declname>
        </param>
        <briefdescription>
<para>Check to see if a Notecard error is present in a JSON string. </para>
        </briefdescription>
        <detaileddescription>
<para>Only Notecard errors enclosed in <computeroutput>{}</computeroutput> (e.g. <computeroutput>{io}</computeroutput> for an I/O error) are guaranteed by the API.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>errstr</parametername>
</parameternamelist>
<parameterdescription>
<para>The string to check for errors. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>errtype</parametername>
</parameternamelist>
<parameterdescription>
<para>The error substring to search for in errstr.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para><computeroutput>true</computeroutput> if errstr contains errtype and <computeroutput>false</computeroutput> otherwise. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="691" column="6" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="691" bodyend="694"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a622a74213848c997191e0fceb7d72c64" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void NoteErrorClean</definition>
        <argsstring>(char *begin)</argsstring>
        <name>NoteErrorClean</name>
        <param>
          <type>char *</type>
          <declname>begin</declname>
        </param>
        <briefdescription>
<para>Clean error strings out of the specified buffer. </para>
        </briefdescription>
        <detaileddescription>
<para>Notecard errors are enclosed in {} (e.g. {io} for an I/O error). This function takes the input string and removes all errors from it, meaning it removes any substrings matching the pattern {some error string}, including the braces.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>begin</parametername>
</parameternamelist>
<parameterdescription>
<para>A C-string to to clean of errors. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="706" column="6" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="706" bodyend="724"/>
      </memberdef>
      <memberdef kind="function" id="n__request_8c_1a56c6c634ffc5ccaa04faf0875c0fe10e" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint64_t</type>
        <definition>uint64_t n_atoh</definition>
        <argsstring>(char *p, int maxLen)</argsstring>
        <name>n_atoh</name>
        <param>
          <type>char *</type>
          <declname>p</declname>
        </param>
        <param>
          <type>int</type>
          <declname>maxLen</declname>
        </param>
        <briefdescription>
<para>Convert a hex string to a 64-bit unsigned integer. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>p</parametername>
</parameternamelist>
<parameterdescription>
<para>The hex string to convert. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>maxLen</parametername>
</parameternamelist>
<parameterdescription>
<para>The length of the hex string.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>The converted number. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/runner/work/note-c/note-c/n_request.c" line="736" column="10" bodyfile="/home/runner/work/note-c/note-c/n_request.c" bodystart="736" bodyend="759"/>
      </memberdef>
      </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
<para>Written by Ray Ozzie and Blues Inc. team.</para>
<para>Copyright (c) 2019 Blues Inc. MIT License. Use of this source code is governed by licenses granted by the copyright holder including that found in the <ulink url="https://github.com/blues/note-c/blob/master/LICENSE">LICENSE</ulink> file. </para>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;n_lib.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>NOTE_C_TEST</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;test_static.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>NOTE_C_STATIC<sp/>static</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight><highlight class="comment">//<sp/>For<sp/>flow<sp/>tracing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>suppressShowTransactions<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Flag<sp/>that<sp/>gets<sp/>set<sp/>whenever<sp/>an<sp/>error<sp/>occurs<sp/>that<sp/>should<sp/>force<sp/>a<sp/>reset</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>resetRequired<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="26"><highlight class="normal"></highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight><highlight class="comment">//<sp/>CRC<sp/>data</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="28"><highlight class="normal"></highlight><highlight class="preprocessor">#ifndef<sp/>NOTE_LOWMEM</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="29"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint16_t<sp/>lastRequestSeqno<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="30"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CRC_FIELD_LENGTH<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>22<sp/><sp/></highlight><highlight class="comment">//<sp/>,&quot;crc&quot;:&quot;SSSS:CCCCCCCC&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="31"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CRC_FIELD_NAME_OFFSET<sp/><sp/><sp/>1</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CRC_FIELD_NAME_TEST<sp/><sp/><sp/><sp/><sp/>&quot;\&quot;crc\&quot;:\&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="33"><highlight class="normal"><ref refid="n__request_8c_1af118c2aba9040de625bebcf41c49e571" kindref="member">NOTE_C_STATIC</ref><sp/>int32_t<sp/>crc32(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal">*<sp/>data,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>length);</highlight></codeline>
<codeline lineno="34"><highlight class="normal"><ref refid="n__request_8c_1af118c2aba9040de625bebcf41c49e571" kindref="member">NOTE_C_STATIC</ref><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<sp/>crcAdd(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*json,<sp/>uint16_t<sp/>seqno);</highlight></codeline>
<codeline lineno="35"><highlight class="normal"><ref refid="n__request_8c_1af118c2aba9040de625bebcf41c49e571" kindref="member">NOTE_C_STATIC</ref><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>crcError(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*json,<sp/>uint16_t<sp/>shouldBeSeqno);</highlight></codeline>
<codeline lineno="36"><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>notecardSupportsCrc<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"></highlight></codeline>
<codeline lineno="52"><highlight class="normal"><ref refid="n__request_8c_1af118c2aba9040de625bebcf41c49e571" kindref="member">NOTE_C_STATIC</ref><sp/><ref refid="struct_j" kindref="compound">J</ref><sp/>*<sp/>errDoc(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*errmsg)</highlight></codeline>
<codeline lineno="53"><highlight class="normal">{</highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_j" kindref="compound">J</ref><sp/>*rspdoc<sp/>=<sp/><ref refid="n__cjson_8h_1ae86ee2002e7ae53d7fa6ccfcae55de0e" kindref="member">JCreateObject</ref>();</highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rspdoc<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1ae1162e04a1b4a9a2f59d5f98dc79d70c" kindref="member">JAddStringToObject</ref>(rspdoc,<sp/>c_err,<sp/>errmsg);</highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1ae1162e04a1b4a9a2f59d5f98dc79d70c" kindref="member">JAddStringToObject</ref>(rspdoc,<sp/></highlight><highlight class="stringliteral">&quot;src&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;note-c&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="58"><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(suppressShowTransactions<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_DebugWithLevel(<ref refid="note_8h_1a6c208024da45b2b4150b2f98d951efb4" kindref="member">NOTE_C_LOG_LEVEL_ERROR</ref>,<sp/></highlight><highlight class="stringliteral">&quot;[ERROR]<sp/>&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_DebugWithLevel(<ref refid="note_8h_1a6c208024da45b2b4150b2f98d951efb4" kindref="member">NOTE_C_LOG_LEVEL_ERROR</ref>,<sp/></highlight><highlight class="stringliteral">&quot;{\&quot;err\&quot;:\&quot;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_DebugWithLevel(<ref refid="note_8h_1a6c208024da45b2b4150b2f98d951efb4" kindref="member">NOTE_C_LOG_LEVEL_ERROR</ref>,<sp/>errmsg);</highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_DebugWithLevelLn(<ref refid="note_8h_1a6c208024da45b2b4150b2f98d951efb4" kindref="member">NOTE_C_LOG_LEVEL_ERROR</ref>,<sp/></highlight><highlight class="stringliteral">&quot;\&quot;,\&quot;src\&quot;:\&quot;note-c\&quot;}&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="66"><highlight class="normal"></highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rspdoc;</highlight></codeline>
<codeline lineno="68"><highlight class="normal">}</highlight></codeline>
<codeline lineno="69"><highlight class="normal"></highlight></codeline>
<codeline lineno="73"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="n__request_8c_1ab0427f0cd3e286d8020309ea88687d09" kindref="member">NoteSuspendTransactionDebug</ref>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="74"><highlight class="normal">{</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/>suppressShowTransactions++;</highlight></codeline>
<codeline lineno="76"><highlight class="normal">}</highlight></codeline>
<codeline lineno="77"><highlight class="normal"></highlight></codeline>
<codeline lineno="81"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="n__request_8c_1a27085ec262c1b7e69d4f8998e2a5219c" kindref="member">NoteResumeTransactionDebug</ref>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="82"><highlight class="normal">{</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/>suppressShowTransactions--;</highlight></codeline>
<codeline lineno="84"><highlight class="normal">}</highlight></codeline>
<codeline lineno="85"><highlight class="normal"></highlight></codeline>
<codeline lineno="96"><highlight class="normal"><ref refid="struct_j" kindref="compound">J</ref><sp/>*<ref refid="n__request_8c_1a2f5fce48cfd817f1bf940ab145f7cc59" kindref="member">NoteNewRequest</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*request)</highlight></codeline>
<codeline lineno="97"><highlight class="normal">{</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_j" kindref="compound">J</ref><sp/>*reqdoc<sp/>=<sp/><ref refid="n__cjson_8h_1ae86ee2002e7ae53d7fa6ccfcae55de0e" kindref="member">JCreateObject</ref>();</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(reqdoc<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1ae1162e04a1b4a9a2f59d5f98dc79d70c" kindref="member">JAddStringToObject</ref>(reqdoc,<sp/>c_req,<sp/>request);</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>reqdoc;</highlight></codeline>
<codeline lineno="103"><highlight class="normal">}</highlight></codeline>
<codeline lineno="104"><highlight class="normal"></highlight></codeline>
<codeline lineno="117"><highlight class="normal"><ref refid="struct_j" kindref="compound">J</ref><sp/>*<ref refid="n__request_8c_1a48877576f8d94864dedbe663ba68c3f0" kindref="member">NoteNewCommand</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*request)</highlight></codeline>
<codeline lineno="118"><highlight class="normal">{</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_j" kindref="compound">J</ref><sp/>*reqdoc<sp/>=<sp/><ref refid="n__cjson_8h_1ae86ee2002e7ae53d7fa6ccfcae55de0e" kindref="member">JCreateObject</ref>();</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(reqdoc<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1ae1162e04a1b4a9a2f59d5f98dc79d70c" kindref="member">JAddStringToObject</ref>(reqdoc,<sp/>c_cmd,<sp/>request);</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>reqdoc;</highlight></codeline>
<codeline lineno="124"><highlight class="normal">}</highlight></codeline>
<codeline lineno="125"><highlight class="normal"></highlight></codeline>
<codeline lineno="144"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="n__request_8c_1ab1227db7501f0b979ed894fb764790e3" kindref="member">NoteRequest</ref>(<ref refid="struct_j" kindref="compound">J</ref><sp/>*req)</highlight></codeline>
<codeline lineno="145"><highlight class="normal">{</highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_j" kindref="compound">J</ref><sp/>*rsp<sp/>=<sp/><ref refid="n__request_8c_1ab163a75667bef7e74294125d40e15c12" kindref="member">NoteRequestResponse</ref>(req);</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rsp<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="150"><highlight class="normal"></highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>for<sp/>a<sp/>transaction<sp/>error,<sp/>and<sp/>exit</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>success<sp/>=<sp/><ref refid="note_8h_1af6782558e937adf063fa560bf006df99" kindref="member">JIsNullString</ref>(rsp,<sp/>c_err);</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a200e39becef910970302806821377a02" kindref="member">JDelete</ref>(rsp);</highlight></codeline>
<codeline lineno="154"><highlight class="normal"></highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>success;</highlight></codeline>
<codeline lineno="156"><highlight class="normal">}</highlight></codeline>
<codeline lineno="157"><highlight class="normal"></highlight></codeline>
<codeline lineno="175"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="n__request_8c_1a7eef6ff395f1e94934d3f9eb99bbcb9a" kindref="member">NoteRequestWithRetry</ref>(<ref refid="struct_j" kindref="compound">J</ref><sp/>*req,<sp/>uint32_t<sp/>timeoutSeconds)</highlight></codeline>
<codeline lineno="176"><highlight class="normal">{</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_j" kindref="compound">J</ref><sp/>*rsp<sp/>=<sp/><ref refid="n__request_8c_1a5d43b857b1bf72f312a2e7ba1825445b" kindref="member">NoteRequestResponseWithRetry</ref>(req,<sp/>timeoutSeconds);</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>there<sp/>is<sp/>no<sp/>response<sp/>return<sp/>false</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rsp<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="182"><highlight class="normal"></highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>for<sp/>a<sp/>transaction<sp/>error,<sp/>and<sp/>exit</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>success<sp/>=<sp/><ref refid="note_8h_1af6782558e937adf063fa560bf006df99" kindref="member">JIsNullString</ref>(rsp,<sp/>c_err);</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a200e39becef910970302806821377a02" kindref="member">JDelete</ref>(rsp);</highlight></codeline>
<codeline lineno="186"><highlight class="normal"></highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>success;</highlight></codeline>
<codeline lineno="188"><highlight class="normal">}</highlight></codeline>
<codeline lineno="189"><highlight class="normal"></highlight></codeline>
<codeline lineno="203"><highlight class="normal"><ref refid="struct_j" kindref="compound">J</ref><sp/>*<ref refid="n__request_8c_1ab163a75667bef7e74294125d40e15c12" kindref="member">NoteRequestResponse</ref>(<ref refid="struct_j" kindref="compound">J</ref><sp/>*req)</highlight></codeline>
<codeline lineno="204"><highlight class="normal">{</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Exit<sp/>if<sp/>null<sp/>request.<sp/>This<sp/>allows<sp/>safe<sp/>execution<sp/>of<sp/>the<sp/>form</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>NoteRequestResponse(NoteNewRequest(&quot;xxx&quot;))</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(req<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Execute<sp/>the<sp/>transaction</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_j" kindref="compound">J</ref><sp/>*rsp<sp/>=<sp/><ref refid="n__request_8c_1a8b5e380054a80026a80c531a734f025c" kindref="member">NoteTransaction</ref>(req);</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rsp<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a200e39becef910970302806821377a02" kindref="member">JDelete</ref>(req);</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Free<sp/>the<sp/>request<sp/>and<sp/>exit</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a200e39becef910970302806821377a02" kindref="member">JDelete</ref>(req);</highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rsp;</highlight></codeline>
<codeline lineno="219"><highlight class="normal">}</highlight></codeline>
<codeline lineno="220"><highlight class="normal"></highlight></codeline>
<codeline lineno="237"><highlight class="normal"><ref refid="struct_j" kindref="compound">J</ref><sp/>*<ref refid="n__request_8c_1a5d43b857b1bf72f312a2e7ba1825445b" kindref="member">NoteRequestResponseWithRetry</ref>(<ref refid="struct_j" kindref="compound">J</ref><sp/>*req,<sp/>uint32_t<sp/>timeoutSeconds)</highlight></codeline>
<codeline lineno="238"><highlight class="normal">{</highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Exit<sp/>if<sp/>null<sp/>request.<sp/>This<sp/>allows<sp/>safe<sp/>execution<sp/>of<sp/>the<sp/>form</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>NoteRequestResponse(NoteNewRequest(&quot;xxx&quot;))</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(req<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="244"><highlight class="normal"></highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_j" kindref="compound">J</ref><sp/>*rsp;</highlight></codeline>
<codeline lineno="246"><highlight class="normal"></highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Calculate<sp/>expiry<sp/>time<sp/>in<sp/>milliseconds</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>startMs<sp/>=<sp/>_GetMs();</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>timeoutMs<sp/>=<sp/>timeoutSeconds<sp/>*<sp/>1000;</highlight></codeline>
<codeline lineno="250"><highlight class="normal"></highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(</highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Execute<sp/>the<sp/>transaction</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rsp<sp/>=<sp/><ref refid="n__request_8c_1a8b5e380054a80026a80c531a734f025c" kindref="member">NoteTransaction</ref>(req);</highlight></codeline>
<codeline lineno="254"><highlight class="normal"></highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Loop<sp/>if<sp/>there<sp/>is<sp/>no<sp/>response,<sp/>or<sp/>if<sp/>there<sp/>is<sp/>an<sp/>io<sp/>error</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/>(rsp<sp/>==<sp/>NULL)<sp/>||<sp/><ref refid="note_8h_1a072439fc8a9e15edc00300eceac8d35e" kindref="member">JContainsString</ref>(rsp,<sp/>c_err,<sp/>c_ioerr))<sp/>{</highlight></codeline>
<codeline lineno="257"><highlight class="normal"></highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Free<sp/>error<sp/>response</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rsp<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a200e39becef910970302806821377a02" kindref="member">JDelete</ref>(rsp);</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rsp<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="264"><highlight class="normal"></highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Exit<sp/>loop<sp/>on<sp/>non-null<sp/>response<sp/>without<sp/>io<sp/>error</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="268"><highlight class="normal"></highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Exit<sp/>loop<sp/>on<sp/>timeout</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(_GetMs()<sp/>-<sp/>startMs<sp/>&gt;=<sp/>timeoutMs)<sp/>{</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="274"><highlight class="normal"></highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Free<sp/>the<sp/>request</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a200e39becef910970302806821377a02" kindref="member">JDelete</ref>(req);</highlight></codeline>
<codeline lineno="277"><highlight class="normal"></highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rsp<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="281"><highlight class="normal"></highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Return<sp/>the<sp/>response</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rsp;</highlight></codeline>
<codeline lineno="284"><highlight class="normal">}</highlight></codeline>
<codeline lineno="285"><highlight class="normal"></highlight></codeline>
<codeline lineno="304"><highlight class="normal"></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<sp/><ref refid="n__request_8c_1a24fcc50f78212b5f7e08ed05b58c0ad1" kindref="member">NoteRequestResponseJSON</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*reqJSON)</highlight></codeline>
<codeline lineno="305"><highlight class="normal">{</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>transactionTimeoutMs<sp/>=<sp/>(CARD_INTER_TRANSACTION_TIMEOUT_SEC<sp/>*<sp/>1000);</highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*rspJSON<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="308"><highlight class="normal"></highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(reqJSON<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="312"><highlight class="normal"></highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>sure<sp/>that<sp/>we<sp/>get<sp/>access<sp/>to<sp/>the<sp/>Notecard<sp/>before<sp/>transacting.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!_TransactionStart(transactionTimeoutMs))<sp/>{</highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="317"><highlight class="normal"></highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/>_LockNote();</highlight></codeline>
<codeline lineno="319"><highlight class="normal"></highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Manually<sp/>tokenize<sp/>the<sp/>string<sp/>to<sp/>search<sp/>for<sp/>multiple<sp/>embedded<sp/>commands<sp/>(cannot<sp/>use<sp/>strtok)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(;;)<sp/>{</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>endPtr<sp/>=<sp/>strchr(reqJSON,<sp/></highlight><highlight class="charliteral">&apos;\n&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="323"><highlight class="normal"></highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>string<sp/>is<sp/>not<sp/>newline-terminated,<sp/>then<sp/>do<sp/>not<sp/>process</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(endPtr<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>reqLen<sp/>=<sp/>((endPtr<sp/>-<sp/>reqJSON)<sp/>+<sp/>1);</highlight></codeline>
<codeline lineno="329"><highlight class="normal"></highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>isCmd<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strstr(reqJSON,<sp/></highlight><highlight class="stringliteral">&quot;\&quot;cmd\&quot;:&quot;</highlight><highlight class="normal">)<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>call<sp/>`JParse()`<sp/>after<sp/>verifying<sp/>the<sp/>provided<sp/>request</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>appears<sp/>to<sp/>contain<sp/>a<sp/>command<sp/>(i.e.<sp/>we<sp/>find<sp/>`&quot;cmd&quot;:`).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_j" kindref="compound">J</ref><sp/>*jsonObj<sp/>=<sp/><ref refid="n__cjson_8h_1ad286b9ae6d487c082caa7a0fa5764f69" kindref="member">JParse</ref>(reqJSON);</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!jsonObj)<sp/>{</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Invalid<sp/>JSON.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>isCmd<sp/>=<sp/><ref refid="note_8h_1a4ee86c1ee5f2774561bc1cb98ab6c864" kindref="member">JIsPresent</ref>(jsonObj,<sp/></highlight><highlight class="stringliteral">&quot;cmd&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a200e39becef910970302806821377a02" kindref="member">JDelete</ref>(jsonObj);</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="342"><highlight class="normal"></highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(isCmd)<sp/>{</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>it&apos;s<sp/>a<sp/>command,<sp/>the<sp/>Notecard<sp/>will<sp/>not<sp/>respond,<sp/>so<sp/>we<sp/>pass<sp/>NULL<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>response<sp/>parameter.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_Transaction(reqJSON,<sp/>reqLen,<sp/>NULL,<sp/>transactionTimeoutMs);</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reqJSON<sp/>=<sp/>(endPtr<sp/>+<sp/>1);</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_Transaction(reqJSON,<sp/>reqLen,<sp/>&amp;rspJSON,<sp/>transactionTimeoutMs);</highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="353"><highlight class="normal"></highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/>_UnlockNote();</highlight></codeline>
<codeline lineno="355"><highlight class="normal"></highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/>_TransactionStop();</highlight></codeline>
<codeline lineno="357"><highlight class="normal"></highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rspJSON;</highlight></codeline>
<codeline lineno="359"><highlight class="normal">}</highlight></codeline>
<codeline lineno="360"><highlight class="normal"></highlight></codeline>
<codeline lineno="374"><highlight class="normal"><ref refid="struct_j" kindref="compound">J</ref><sp/>*<ref refid="n__request_8c_1a8b5e380054a80026a80c531a734f025c" kindref="member">NoteTransaction</ref>(<ref refid="struct_j" kindref="compound">J</ref><sp/>*req)</highlight></codeline>
<codeline lineno="375"><highlight class="normal">{</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="n__request_8c_1ad807b7de69820e7c5f308f8caba96562" kindref="member">noteTransactionShouldLock</ref>(req,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="377"><highlight class="normal">}</highlight></codeline>
<codeline lineno="378"><highlight class="normal"></highlight></codeline>
<codeline lineno="379"><highlight class="normal"></highlight><highlight class="comment">/**************************************************************************/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="390"><highlight class="normal"></highlight><highlight class="comment">/**************************************************************************/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="391"><highlight class="normal"><ref refid="struct_j" kindref="compound">J</ref><sp/>*<ref refid="n__request_8c_1ad807b7de69820e7c5f308f8caba96562" kindref="member">noteTransactionShouldLock</ref>(<ref refid="struct_j" kindref="compound">J</ref><sp/>*req,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>lockNotecard)</highlight></codeline>
<codeline lineno="392"><highlight class="normal">{</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Validate<sp/>in<sp/>case<sp/>of<sp/>memory<sp/>failure<sp/>of<sp/>the<sp/>requestor</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(req<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="397"><highlight class="normal"></highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>sure<sp/>that<sp/>we<sp/>get<sp/>access<sp/>to<sp/>the<sp/>notecard<sp/>hardware<sp/>before<sp/>we<sp/>begin</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!_TransactionStart(CARD_INTER_TRANSACTION_TIMEOUT_SEC<sp/>*<sp/>1000))<sp/>{</highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="402"><highlight class="normal"></highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Determine<sp/>the<sp/>request<sp/>or<sp/>command<sp/>type</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*reqType<sp/>=<sp/><ref refid="note_8h_1aa2037e372291b35bb6ecc03cb667f824" kindref="member">JGetString</ref>(req,<sp/></highlight><highlight class="stringliteral">&quot;req&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*cmdType<sp/>=<sp/><ref refid="note_8h_1aa2037e372291b35bb6ecc03cb667f824" kindref="member">JGetString</ref>(req,<sp/></highlight><highlight class="stringliteral">&quot;cmd&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="406"><highlight class="normal"></highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>the<sp/>user<sp/>agent<sp/>object<sp/>only<sp/>when<sp/>we&apos;re<sp/>doing<sp/>a<sp/>hub.set<sp/>and<sp/>only<sp/>when<sp/>we&apos;re</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>specifying<sp/>the<sp/>product<sp/>UID.<sp/><sp/>The<sp/>intent<sp/>is<sp/>that<sp/>we<sp/>only<sp/>piggyback<sp/>user<sp/>agent</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>data<sp/>when<sp/>the<sp/>host<sp/>is<sp/>initializing<sp/>the<sp/>Notecard,<sp/>as<sp/>opposed<sp/>to<sp/>every<sp/>time</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>host<sp/>does<sp/>a<sp/>hub.set<sp/>to<sp/>change<sp/>mode.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="411"><highlight class="normal"></highlight><highlight class="preprocessor">#ifndef<sp/>NOTE_DISABLE_USER_AGENT</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="note_8h_1a4ee86c1ee5f2774561bc1cb98ab6c864" kindref="member">JIsPresent</ref>(req,<sp/></highlight><highlight class="stringliteral">&quot;body&quot;</highlight><highlight class="normal">)<sp/>&amp;&amp;<sp/>(strcmp(reqType,<sp/></highlight><highlight class="stringliteral">&quot;hub.set&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0)<sp/>&amp;&amp;<sp/><ref refid="note_8h_1a4ee86c1ee5f2774561bc1cb98ab6c864" kindref="member">JIsPresent</ref>(req,<sp/></highlight><highlight class="stringliteral">&quot;product&quot;</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_j" kindref="compound">J</ref><sp/>*body<sp/>=<sp/><ref refid="note_8h_1a7df3b564875a8975cf524851a4f83ff9" kindref="member">NoteUserAgent</ref>();</highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(body<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a3430617fcd905e9d3d997354cb7e23cc" kindref="member">JAddItemToObject</ref>(req,<sp/></highlight><highlight class="stringliteral">&quot;body&quot;</highlight><highlight class="normal">,<sp/>body);</highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="418"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="419"><highlight class="normal"></highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Determine<sp/>whether<sp/>or<sp/>not<sp/>a<sp/>response<sp/>will<sp/>be<sp/>expected,<sp/>by<sp/>virtue<sp/>of<sp/>&quot;cmd&quot;<sp/>being<sp/>present</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>noResponseExpected<sp/>=<sp/>(reqType[0]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>cmdType[0]<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="422"><highlight class="normal"></highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>a<sp/>reset<sp/>of<sp/>the<sp/>module<sp/>is<sp/>required<sp/>for<sp/>any<sp/>reason,<sp/>do<sp/>it<sp/>now.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>must<sp/>do<sp/>this<sp/>before<sp/>acquiring<sp/>lock.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(resetRequired)<sp/>{</highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="n__request_8c_1a6358096b5a9e5c69a4f56b12e80092fa" kindref="member">NoteReset</ref>())<sp/>{</highlight></codeline>
<codeline lineno="427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_TransactionStop();</highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="431"><highlight class="normal"></highlight></codeline>
<codeline lineno="432"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lockNotecard)<sp/>{</highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_LockNote();</highlight></codeline>
<codeline lineno="434"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="435"><highlight class="normal"></highlight></codeline>
<codeline lineno="436"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Serialize<sp/>the<sp/>JSON<sp/>request</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="437"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*json<sp/>=<sp/><ref refid="n__cjson_8h_1a458985772911635a0d904e575a5c7839" kindref="member">JPrintUnformatted</ref>(req);</highlight></codeline>
<codeline lineno="438"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(json<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_j" kindref="compound">J</ref><sp/>*errRsp<sp/>=<sp/>errDoc(<ref refid="note_8h_1a842e0f5c7170ddfde0164bad199d6fdc" kindref="member">ERRSTR</ref>(</highlight><highlight class="stringliteral">&quot;can&apos;t<sp/>convert<sp/>to<sp/>JSON&quot;</highlight><highlight class="normal">,<sp/>c_bad));</highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lockNotecard)<sp/>{</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_UnlockNote();</highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_TransactionStop();</highlight></codeline>
<codeline lineno="444"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>errRsp;</highlight></codeline>
<codeline lineno="445"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="446"><highlight class="normal"></highlight></codeline>
<codeline lineno="447"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>it<sp/>is<sp/>a<sp/>request<sp/>(as<sp/>opposed<sp/>to<sp/>a<sp/>command),<sp/>include<sp/>a<sp/>CRC<sp/>so<sp/>that<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="448"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>request<sp/>might<sp/>be<sp/>retried<sp/>if<sp/>it<sp/>is<sp/>received<sp/>in<sp/>a<sp/>corrupted<sp/>state.<sp/><sp/>(We<sp/>can</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="449"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>only<sp/>do<sp/>this<sp/>on<sp/>requests<sp/>because<sp/>for<sp/>cmd&apos;s<sp/>there<sp/>is<sp/>no<sp/>&apos;response<sp/>channel&apos;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>where<sp/>we<sp/>can<sp/>find<sp/>out<sp/>that<sp/>the<sp/>cmd<sp/>failed.<sp/><sp/>Note<sp/>that<sp/>a<sp/>Seqno<sp/>is<sp/>included</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>as<sp/>part<sp/>of<sp/>the<sp/>CRC<sp/>data<sp/>so<sp/>that<sp/>two<sp/>identical<sp/>requests<sp/>occurring<sp/>within<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>modulus<sp/>of<sp/>seqno<sp/>never<sp/>are<sp/>mistaken<sp/>as<sp/>being<sp/>the<sp/>same<sp/>request<sp/>being<sp/>retried.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>lastRequestRetries<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="454"><highlight class="normal"></highlight><highlight class="preprocessor">#ifndef<sp/>NOTE_LOWMEM</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="455"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>lastRequestCrcAdded<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="456"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!noResponseExpected)<sp/>{</highlight></codeline>
<codeline lineno="457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*newJson<sp/>=<sp/>crcAdd(json,<sp/>lastRequestSeqno);</highlight></codeline>
<codeline lineno="458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(newJson<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a65411d47da558e0084a07a773275218b" kindref="member">JFree</ref>(json);</highlight></codeline>
<codeline lineno="460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>json<sp/>=<sp/>newJson;</highlight></codeline>
<codeline lineno="461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lastRequestCrcAdded<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="463"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="464"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/></highlight><highlight class="comment">//<sp/>!NOTE_LOWMEM</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="465"><highlight class="normal"></highlight></codeline>
<codeline lineno="466"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>note.add<sp/>or<sp/>web.*<sp/>requests<sp/>are<sp/>used<sp/>to<sp/>transfer<sp/>binary<sp/>data,<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="467"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>time<sp/>to<sp/>complete<sp/>the<sp/>transaction<sp/>can<sp/>vary<sp/>depending<sp/>on<sp/>the<sp/>size<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="468"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>payload<sp/>and<sp/>network<sp/>conditions.<sp/>Therefore,<sp/>it&apos;s<sp/>possible<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>these<sp/>transactions<sp/>to<sp/>timeout<sp/>prematurely.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="470"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="471"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>algorithm<sp/>below,<sp/>executes<sp/>the<sp/>following<sp/>logic:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="472"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>-<sp/>If<sp/>the<sp/>request<sp/>is<sp/>a<sp/>`note.add`,<sp/>set<sp/>the<sp/>timeout<sp/>value<sp/>to<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/>value<sp/>of<sp/>the<sp/>&quot;milliseconds&quot;<sp/>parameter,<sp/>if<sp/>it<sp/>exists.<sp/>If<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="474"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/>doesn&apos;t,<sp/>use<sp/>the<sp/>&quot;seconds&quot;<sp/>parameter.<sp/>If<sp/>that<sp/>doesn&apos;t<sp/>exist,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="475"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/>use<sp/>the<sp/>standard<sp/>timeout<sp/>of<sp/>`CARD_INTER_TRANSACTION_TIMEOUT_SEC`.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="476"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>-<sp/>If<sp/>the<sp/>request<sp/>is<sp/>a<sp/>`web.*`,<sp/>follow<sp/>the<sp/>same<sp/>logic,<sp/>but<sp/>instead</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="477"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/>of<sp/>using<sp/>the<sp/>standard<sp/>timeout,<sp/>use<sp/>the<sp/>Notecard<sp/>timeout<sp/>of<sp/>90</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="478"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/>seconds<sp/>for<sp/>all<sp/>`web.*`<sp/>transactions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="479"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>transactionTimeoutMs<sp/>=<sp/>(CARD_INTER_TRANSACTION_TIMEOUT_SEC<sp/>*<sp/>1000);</highlight></codeline>
<codeline lineno="480"><highlight class="normal"></highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Interrogate<sp/>the<sp/>request</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="482"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="note_8h_1a072439fc8a9e15edc00300eceac8d35e" kindref="member">JContainsString</ref>(req,<sp/>(reqType<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;req&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;cmd&quot;</highlight><highlight class="normal">),<sp/></highlight><highlight class="stringliteral">&quot;note.add&quot;</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="note_8h_1a4ee86c1ee5f2774561bc1cb98ab6c864" kindref="member">JIsPresent</ref>(req,<sp/></highlight><highlight class="stringliteral">&quot;milliseconds&quot;</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a3123fd4930117eb19b75fef8199d6032" kindref="member">NOTE_C_LOG_DEBUG</ref>(</highlight><highlight class="stringliteral">&quot;Using<sp/>`milliseconds`<sp/>parameter<sp/>value<sp/>for<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;timeout.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>transactionTimeoutMs<sp/>=<sp/><ref refid="note_8h_1a94c534da4da8f0aa53cc615fbb29709a" kindref="member">JGetInt</ref>(req,<sp/></highlight><highlight class="stringliteral">&quot;milliseconds&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="note_8h_1a4ee86c1ee5f2774561bc1cb98ab6c864" kindref="member">JIsPresent</ref>(req,<sp/></highlight><highlight class="stringliteral">&quot;seconds&quot;</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a3123fd4930117eb19b75fef8199d6032" kindref="member">NOTE_C_LOG_DEBUG</ref>(</highlight><highlight class="stringliteral">&quot;Using<sp/>`seconds`<sp/>parameter<sp/>value<sp/>for<sp/>timeout.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>transactionTimeoutMs<sp/>=<sp/>(<ref refid="note_8h_1a94c534da4da8f0aa53cc615fbb29709a" kindref="member">JGetInt</ref>(req,<sp/></highlight><highlight class="stringliteral">&quot;seconds&quot;</highlight><highlight class="normal">)<sp/>*<sp/>1000);</highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="491"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="note_8h_1a072439fc8a9e15edc00300eceac8d35e" kindref="member">JContainsString</ref>(req,<sp/>(reqType<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;req&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;cmd&quot;</highlight><highlight class="normal">),<sp/></highlight><highlight class="stringliteral">&quot;web.&quot;</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a3123fd4930117eb19b75fef8199d6032" kindref="member">NOTE_C_LOG_DEBUG</ref>(</highlight><highlight class="stringliteral">&quot;web.*<sp/>request<sp/>received.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="note_8h_1a4ee86c1ee5f2774561bc1cb98ab6c864" kindref="member">JIsPresent</ref>(req,<sp/></highlight><highlight class="stringliteral">&quot;milliseconds&quot;</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a3123fd4930117eb19b75fef8199d6032" kindref="member">NOTE_C_LOG_DEBUG</ref>(</highlight><highlight class="stringliteral">&quot;Using<sp/>`milliseconds`<sp/>parameter<sp/>value<sp/>for<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;timeout.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>transactionTimeoutMs<sp/>=<sp/><ref refid="note_8h_1a94c534da4da8f0aa53cc615fbb29709a" kindref="member">JGetInt</ref>(req,<sp/></highlight><highlight class="stringliteral">&quot;milliseconds&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="note_8h_1a4ee86c1ee5f2774561bc1cb98ab6c864" kindref="member">JIsPresent</ref>(req,<sp/></highlight><highlight class="stringliteral">&quot;seconds&quot;</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a3123fd4930117eb19b75fef8199d6032" kindref="member">NOTE_C_LOG_DEBUG</ref>(</highlight><highlight class="stringliteral">&quot;Using<sp/>`seconds`<sp/>parameter<sp/>value<sp/>for<sp/>timeout.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>transactionTimeoutMs<sp/>=<sp/>(<ref refid="note_8h_1a94c534da4da8f0aa53cc615fbb29709a" kindref="member">JGetInt</ref>(req,<sp/></highlight><highlight class="stringliteral">&quot;seconds&quot;</highlight><highlight class="normal">)<sp/>*<sp/>1000);</highlight></codeline>
<codeline lineno="500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a3123fd4930117eb19b75fef8199d6032" kindref="member">NOTE_C_LOG_DEBUG</ref>(</highlight><highlight class="stringliteral">&quot;No<sp/>`milliseconds`<sp/>or<sp/>`seconds`<sp/>parameter<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;provided.<sp/>Defaulting<sp/>to<sp/>90-second<sp/>timeout.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>transactionTimeoutMs<sp/>=<sp/>(90<sp/>*<sp/>1000);</highlight></codeline>
<codeline lineno="504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="506"><highlight class="normal"></highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we&apos;re<sp/>performing<sp/>retries,<sp/>this<sp/>is<sp/>where<sp/>we<sp/>come<sp/>back<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="508"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*errStr<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="509"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*responseJSON<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_j" kindref="compound">J</ref><sp/>*rsp<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>no<sp/>retry<sp/>possibility,<sp/>break<sp/>out</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lastRequestRetries<sp/>&gt;<sp/>CARD_REQUEST_RETRIES_ALLOWED)<sp/>{</highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>free<sp/>on<sp/>retry</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a200e39becef910970302806821377a02" kindref="member">JDelete</ref>(rsp);</highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="519"><highlight class="normal"></highlight></codeline>
<codeline lineno="520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>reset<sp/>variables</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rsp<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>responseJSON<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="523"><highlight class="normal"></highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Trace</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(suppressShowTransactions<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a260d740972b2082c72f77b416713f5a0" kindref="member">NOTE_C_LOG_INFO</ref>(json);</highlight></codeline>
<codeline lineno="527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="528"><highlight class="normal"></highlight></codeline>
<codeline lineno="529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Swap<sp/>NULL-terminator<sp/>for<sp/>newline-terminator</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>jsonLen<sp/>=<sp/>strlen(json);</highlight></codeline>
<codeline lineno="531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>json[jsonLen]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\n&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="532"><highlight class="normal"></highlight></codeline>
<codeline lineno="533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Perform<sp/>the<sp/>transaction</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="534"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(noResponseExpected)<sp/>{</highlight></codeline>
<codeline lineno="535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>errStr<sp/>=<sp/>_Transaction(json,<sp/>(jsonLen<sp/>+<sp/>1),<sp/>NULL,<sp/>transactionTimeoutMs);</highlight></codeline>
<codeline lineno="536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>errStr<sp/>=<sp/>_Transaction(json,<sp/>(jsonLen<sp/>+<sp/>1),<sp/>&amp;responseJSON,<sp/>transactionTimeoutMs);</highlight></codeline>
<codeline lineno="539"><highlight class="normal"></highlight></codeline>
<codeline lineno="540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Swap<sp/>newline-terminator<sp/>for<sp/>NULL-terminator</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>json[jsonLen]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="542"><highlight class="normal"></highlight></codeline>
<codeline lineno="543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>there&apos;s<sp/>an<sp/>I/O<sp/>error<sp/>on<sp/>the<sp/>transaction,<sp/>retry</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(errStr<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a65411d47da558e0084a07a773275218b" kindref="member">JFree</ref>(responseJSON);</highlight></codeline>
<codeline lineno="546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>resetRequired<sp/>=<sp/>!_Reset();</highlight></codeline>
<codeline lineno="547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lastRequestRetries++;</highlight></codeline>
<codeline lineno="548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a7ac988c4204339520399f37a04eb4110" kindref="member">NOTE_C_LOG_WARN</ref>(<ref refid="note_8h_1a842e0f5c7170ddfde0164bad199d6fdc" kindref="member">ERRSTR</ref>(</highlight><highlight class="stringliteral">&quot;retrying<sp/>I/O<sp/>error<sp/>detected<sp/>by<sp/>host&quot;</highlight><highlight class="normal">,<sp/>c_iobad));</highlight></codeline>
<codeline lineno="549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_DelayMs(500);</highlight></codeline>
<codeline lineno="550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="552"><highlight class="normal"></highlight></codeline>
<codeline lineno="553"><highlight class="normal"></highlight><highlight class="preprocessor">#ifndef<sp/>NOTE_LOWMEM</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>sent<sp/>a<sp/>CRC<sp/>in<sp/>the<sp/>request,<sp/>examine<sp/>the<sp/>response<sp/>JSON<sp/>to<sp/>see<sp/>if</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it<sp/>has<sp/>a<sp/>CRC<sp/>error.<sp/><sp/>Note<sp/>that<sp/>the<sp/>CRC<sp/>is<sp/>stripped<sp/>from<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="556"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>responseJSON<sp/>as<sp/>a<sp/>side-effect<sp/>of<sp/>this<sp/>method.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="557"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lastRequestCrcAdded<sp/>&amp;&amp;<sp/>crcError(responseJSON,<sp/>lastRequestSeqno))<sp/>{</highlight></codeline>
<codeline lineno="558"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a65411d47da558e0084a07a773275218b" kindref="member">JFree</ref>(responseJSON);</highlight></codeline>
<codeline lineno="559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>errStr<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;crc<sp/>error<sp/>{io}&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="560"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lastRequestRetries++;</highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a87c75bac44560f4cbb8573dc0048169a" kindref="member">NOTE_C_LOG_ERROR</ref>(<ref refid="note_8h_1a842e0f5c7170ddfde0164bad199d6fdc" kindref="member">ERRSTR</ref>(</highlight><highlight class="stringliteral">&quot;CRC<sp/>error<sp/>on<sp/>response&quot;</highlight><highlight class="normal">,<sp/>c_iobad));</highlight></codeline>
<codeline lineno="562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_DelayMs(500);</highlight></codeline>
<codeline lineno="563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="565"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/></highlight><highlight class="comment">//<sp/>!NOTE_LOWMEM</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="566"><highlight class="normal"></highlight></codeline>
<codeline lineno="567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>See<sp/>if<sp/>the<sp/>response<sp/>JSON<sp/>can&apos;t<sp/>be<sp/>unmarshaled,<sp/>or<sp/>if<sp/>it<sp/>contains<sp/>an<sp/>{io}<sp/>error</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rsp<sp/>=<sp/><ref refid="n__cjson_8h_1ad286b9ae6d487c082caa7a0fa5764f69" kindref="member">JParse</ref>(responseJSON);</highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>isBadBin<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>isIoError<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rsp<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>isBadBin<sp/>=<sp/><ref refid="n__request_8c_1a1385294098059d94d366e2fd843358e5" kindref="member">NoteErrorContains</ref>(<ref refid="note_8h_1aa2037e372291b35bb6ecc03cb667f824" kindref="member">JGetString</ref>(rsp,<sp/>c_err),<sp/>c_badbinerr);</highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>isIoError<sp/>=<sp/><ref refid="n__request_8c_1a1385294098059d94d366e2fd843358e5" kindref="member">NoteErrorContains</ref>(<ref refid="note_8h_1aa2037e372291b35bb6ecc03cb667f824" kindref="member">JGetString</ref>(rsp,<sp/>c_err),<sp/>c_ioerr);</highlight></codeline>
<codeline lineno="574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Failed<sp/>to<sp/>parse<sp/>response<sp/>as<sp/>JSON</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(responseJSON<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a87c75bac44560f4cbb8573dc0048169a" kindref="member">NOTE_C_LOG_ERROR</ref>(<ref refid="note_8h_1a842e0f5c7170ddfde0164bad199d6fdc" kindref="member">ERRSTR</ref>(</highlight><highlight class="stringliteral">&quot;response<sp/>expected,<sp/>but<sp/>response<sp/>is<sp/>NULL.&quot;</highlight><highlight class="normal">,<sp/>c_ioerr));</highlight></codeline>
<codeline lineno="578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="579"><highlight class="normal"></highlight><highlight class="preprocessor">#ifndef<sp/>NOTE_LOWMEM</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_DebugWithLevel(<ref refid="note_8h_1a6c208024da45b2b4150b2f98d951efb4" kindref="member">NOTE_C_LOG_LEVEL_ERROR</ref>,<sp/></highlight><highlight class="stringliteral">&quot;[ERROR]<sp/>&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_DebugWithLevel(<ref refid="note_8h_1a6c208024da45b2b4150b2f98d951efb4" kindref="member">NOTE_C_LOG_LEVEL_ERROR</ref>,<sp/></highlight><highlight class="stringliteral">&quot;invalid<sp/>JSON:<sp/>&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_DebugWithLevel(<ref refid="note_8h_1a6c208024da45b2b4150b2f98d951efb4" kindref="member">NOTE_C_LOG_LEVEL_ERROR</ref>,<sp/>responseJSON);</highlight></codeline>
<codeline lineno="583"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a87c75bac44560f4cbb8573dc0048169a" kindref="member">NOTE_C_LOG_ERROR</ref>(c_ioerr);</highlight></codeline>
<codeline lineno="585"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>isIoError<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(isIoError<sp/>||<sp/>isBadBin)<sp/>{</highlight></codeline>
<codeline lineno="590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a87c75bac44560f4cbb8573dc0048169a" kindref="member">NOTE_C_LOG_ERROR</ref>(<ref refid="note_8h_1aa2037e372291b35bb6ecc03cb667f824" kindref="member">JGetString</ref>(rsp,<sp/>c_err));</highlight></codeline>
<codeline lineno="591"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a65411d47da558e0084a07a773275218b" kindref="member">JFree</ref>(responseJSON);</highlight></codeline>
<codeline lineno="592"><highlight class="normal"></highlight></codeline>
<codeline lineno="593"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(isBadBin)<sp/>{</highlight></codeline>
<codeline lineno="594"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>errStr<sp/>=<sp/><ref refid="note_8h_1a842e0f5c7170ddfde0164bad199d6fdc" kindref="member">ERRSTR</ref>(</highlight><highlight class="stringliteral">&quot;notecard<sp/>binary<sp/>i/o<sp/>error<sp/>{bad-bin}{io}&quot;</highlight><highlight class="normal">,<sp/>c_badbinerr);</highlight></codeline>
<codeline lineno="595"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a3123fd4930117eb19b75fef8199d6032" kindref="member">NOTE_C_LOG_DEBUG</ref>(</highlight><highlight class="stringliteral">&quot;{bad-bin}<sp/>is<sp/>not<sp/>elibigle<sp/>for<sp/>retry&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="596"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="597"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="598"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>errStr<sp/>=<sp/><ref refid="note_8h_1a842e0f5c7170ddfde0164bad199d6fdc" kindref="member">ERRSTR</ref>(</highlight><highlight class="stringliteral">&quot;notecard<sp/>i/o<sp/>error<sp/>{io}&quot;</highlight><highlight class="normal">,<sp/>c_ioerr);</highlight></codeline>
<codeline lineno="599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lastRequestRetries++;</highlight></codeline>
<codeline lineno="600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a7ac988c4204339520399f37a04eb4110" kindref="member">NOTE_C_LOG_WARN</ref>(<ref refid="note_8h_1a842e0f5c7170ddfde0164bad199d6fdc" kindref="member">ERRSTR</ref>(</highlight><highlight class="stringliteral">&quot;retrying<sp/>I/O<sp/>error<sp/>detected<sp/>by<sp/>notecard&quot;</highlight><highlight class="normal">,<sp/>c_iobad));</highlight></codeline>
<codeline lineno="601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_DelayMs(500);</highlight></codeline>
<codeline lineno="602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="605"><highlight class="normal"></highlight></codeline>
<codeline lineno="606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Transaction<sp/>completed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="607"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="608"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="609"><highlight class="normal"></highlight></codeline>
<codeline lineno="610"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Bump<sp/>the<sp/>request<sp/>sequence<sp/>number<sp/>now<sp/>that<sp/>we&apos;ve<sp/>processed<sp/>this<sp/>request,<sp/>success<sp/>or<sp/>error</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="611"><highlight class="normal"></highlight><highlight class="preprocessor">#ifndef<sp/>NOTE_LOWMEM</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="612"><highlight class="normal"><sp/><sp/><sp/><sp/>lastRequestSeqno++;</highlight></codeline>
<codeline lineno="613"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="614"><highlight class="normal"></highlight></codeline>
<codeline lineno="615"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Free<sp/>the<sp/>original<sp/>serialized<sp/>JSON<sp/>request</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="616"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a65411d47da558e0084a07a773275218b" kindref="member">JFree</ref>(json);</highlight></codeline>
<codeline lineno="617"><highlight class="normal"></highlight></codeline>
<codeline lineno="618"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>error,<sp/>queue<sp/>up<sp/>a<sp/>reset</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="619"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(errStr<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a200e39becef910970302806821377a02" kindref="member">JDelete</ref>(rsp);</highlight></codeline>
<codeline lineno="621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="n__request_8c_1a6c62afa66443f9dbb0a36bf9f76e9896" kindref="member">NoteResetRequired</ref>();</highlight></codeline>
<codeline lineno="622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_j" kindref="compound">J</ref><sp/>*errRsp<sp/>=<sp/>errDoc(errStr);</highlight></codeline>
<codeline lineno="623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lockNotecard)<sp/>{</highlight></codeline>
<codeline lineno="624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_UnlockNote();</highlight></codeline>
<codeline lineno="625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_TransactionStop();</highlight></codeline>
<codeline lineno="627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>errRsp;</highlight></codeline>
<codeline lineno="628"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="629"><highlight class="normal"></highlight></codeline>
<codeline lineno="630"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Exit<sp/>with<sp/>a<sp/>blank<sp/>object<sp/>(with<sp/>no<sp/>err<sp/>field)<sp/>if<sp/>no<sp/>response<sp/>expected</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="631"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(noResponseExpected)<sp/>{</highlight></codeline>
<codeline lineno="632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lockNotecard)<sp/>{</highlight></codeline>
<codeline lineno="633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_UnlockNote();</highlight></codeline>
<codeline lineno="634"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="635"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_TransactionStop();</highlight></codeline>
<codeline lineno="636"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="n__cjson_8h_1ae86ee2002e7ae53d7fa6ccfcae55de0e" kindref="member">JCreateObject</ref>();</highlight></codeline>
<codeline lineno="637"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="638"><highlight class="normal"></highlight></codeline>
<codeline lineno="639"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Debug</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="640"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(suppressShowTransactions<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="641"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="note_8h_1a260d740972b2082c72f77b416713f5a0" kindref="member">NOTE_C_LOG_INFO</ref>(responseJSON);</highlight></codeline>
<codeline lineno="642"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="643"><highlight class="normal"></highlight></codeline>
<codeline lineno="644"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Discard<sp/>the<sp/>buffer<sp/>now<sp/>that<sp/>it<sp/>has<sp/>been<sp/>logged</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="645"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="n__cjson_8h_1a65411d47da558e0084a07a773275218b" kindref="member">JFree</ref>(responseJSON);</highlight></codeline>
<codeline lineno="646"><highlight class="normal"></highlight></codeline>
<codeline lineno="647"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lockNotecard)<sp/>{</highlight></codeline>
<codeline lineno="648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_UnlockNote();</highlight></codeline>
<codeline lineno="649"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="650"><highlight class="normal"></highlight></codeline>
<codeline lineno="651"><highlight class="normal"><sp/><sp/><sp/><sp/>_TransactionStop();</highlight></codeline>
<codeline lineno="652"><highlight class="normal"></highlight></codeline>
<codeline lineno="653"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Done</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="654"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rsp;</highlight></codeline>
<codeline lineno="655"><highlight class="normal"></highlight></codeline>
<codeline lineno="656"><highlight class="normal">}</highlight></codeline>
<codeline lineno="657"><highlight class="normal"></highlight></codeline>
<codeline lineno="662"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="n__request_8c_1a6c62afa66443f9dbb0a36bf9f76e9896" kindref="member">NoteResetRequired</ref>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="663"><highlight class="normal">{</highlight></codeline>
<codeline lineno="664"><highlight class="normal"><sp/><sp/><sp/><sp/>resetRequired<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="665"><highlight class="normal">}</highlight></codeline>
<codeline lineno="666"><highlight class="normal"></highlight></codeline>
<codeline lineno="672"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="n__request_8c_1a6358096b5a9e5c69a4f56b12e80092fa" kindref="member">NoteReset</ref>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="673"><highlight class="normal">{</highlight></codeline>
<codeline lineno="674"><highlight class="normal"><sp/><sp/><sp/><sp/>_LockNote();</highlight></codeline>
<codeline lineno="675"><highlight class="normal"><sp/><sp/><sp/><sp/>resetRequired<sp/>=<sp/>!_Reset();</highlight></codeline>
<codeline lineno="676"><highlight class="normal"><sp/><sp/><sp/><sp/>_UnlockNote();</highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>!resetRequired;</highlight></codeline>
<codeline lineno="678"><highlight class="normal">}</highlight></codeline>
<codeline lineno="679"><highlight class="normal"></highlight></codeline>
<codeline lineno="691"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="n__request_8c_1a1385294098059d94d366e2fd843358e5" kindref="member">NoteErrorContains</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*errstr,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*errtype)</highlight></codeline>
<codeline lineno="692"><highlight class="normal">{</highlight></codeline>
<codeline lineno="693"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(strstr(errstr,<sp/>errtype)<sp/>!=<sp/>NULL);</highlight></codeline>
<codeline lineno="694"><highlight class="normal">}</highlight></codeline>
<codeline lineno="695"><highlight class="normal"></highlight></codeline>
<codeline lineno="706"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="n__request_8c_1a622a74213848c997191e0fceb7d72c64" kindref="member">NoteErrorClean</ref>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*begin)</highlight></codeline>
<codeline lineno="707"><highlight class="normal">{</highlight></codeline>
<codeline lineno="708"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*end<sp/>=<sp/>&amp;begin[strlen(begin)+1];</highlight></codeline>
<codeline lineno="710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*beginBrace<sp/>=<sp/>strchr(begin,<sp/></highlight><highlight class="charliteral">&apos;{&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="711"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(beginBrace<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="714"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(beginBrace&gt;begin<sp/>&amp;&amp;<sp/>*(beginBrace-1)<sp/>==<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="715"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>beginBrace--;</highlight></codeline>
<codeline lineno="716"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="717"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*endBrace<sp/>=<sp/>strchr(beginBrace,<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(endBrace<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="719"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*afterBrace<sp/>=<sp/>endBrace<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memmove(beginBrace,<sp/>afterBrace,<sp/>end-afterBrace);</highlight></codeline>
<codeline lineno="723"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="724"><highlight class="normal">}</highlight></codeline>
<codeline lineno="725"><highlight class="normal"></highlight></codeline>
<codeline lineno="726"><highlight class="normal"></highlight><highlight class="preprocessor">#ifndef<sp/>NOTE_LOWMEM</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="727"><highlight class="normal"></highlight></codeline>
<codeline lineno="736"><highlight class="normal">uint64_t<sp/><ref refid="n__request_8c_1a56c6c634ffc5ccaa04faf0875c0fe10e" kindref="member">n_atoh</ref>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>maxLen)</highlight></codeline>
<codeline lineno="737"><highlight class="normal">{</highlight></codeline>
<codeline lineno="738"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>n<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="739"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*ep<sp/>=<sp/>p+maxLen;</highlight></codeline>
<codeline lineno="740"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(p<sp/>&lt;<sp/>ep)<sp/>{</highlight></codeline>
<codeline lineno="741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>ch<sp/>=<sp/>*p++;</highlight></codeline>
<codeline lineno="742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>digit<sp/>=<sp/>(ch<sp/>&gt;=<sp/></highlight><highlight class="charliteral">&apos;0&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>ch<sp/>&lt;=<sp/></highlight><highlight class="charliteral">&apos;9&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="743"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>lcase<sp/>=<sp/>(ch<sp/>&gt;=<sp/></highlight><highlight class="charliteral">&apos;a&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>ch<sp/>&lt;=<sp/></highlight><highlight class="charliteral">&apos;f&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="744"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>space<sp/>=<sp/>(ch<sp/>==<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="745"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ucase<sp/>=<sp/>(ch<sp/>&gt;=<sp/></highlight><highlight class="charliteral">&apos;A&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>ch<sp/>&lt;=<sp/></highlight><highlight class="charliteral">&apos;F&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="746"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!digit<sp/>&amp;&amp;<sp/>!lcase<sp/>&amp;&amp;<sp/>!space<sp/>&amp;&amp;<sp/>!ucase)<sp/>{</highlight></codeline>
<codeline lineno="747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="749"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>n<sp/>*=<sp/>16;</highlight></codeline>
<codeline lineno="750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(digit)<sp/>{</highlight></codeline>
<codeline lineno="751"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>n<sp/>+=<sp/>ch<sp/>-<sp/></highlight><highlight class="charliteral">&apos;0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lcase)<sp/>{</highlight></codeline>
<codeline lineno="753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>n<sp/>+=<sp/>10<sp/>+<sp/>(ch<sp/>-<sp/></highlight><highlight class="charliteral">&apos;a&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ucase)<sp/>{</highlight></codeline>
<codeline lineno="755"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>n<sp/>+=<sp/>10<sp/>+<sp/>(ch<sp/>-<sp/></highlight><highlight class="charliteral">&apos;A&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="756"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="757"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="758"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(n);</highlight></codeline>
<codeline lineno="759"><highlight class="normal">}</highlight></codeline>
<codeline lineno="760"><highlight class="normal"></highlight></codeline>
<codeline lineno="761"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint32_t<sp/>lut[16]<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="762"><highlight class="normal"><sp/><sp/><sp/><sp/>0x00000000,<sp/>0x1DB71064,<sp/>0x3B6E20C8,<sp/>0x26D930AC,<sp/>0x76DC4190,<sp/>0x6B6B51F4,</highlight></codeline>
<codeline lineno="763"><highlight class="normal"><sp/><sp/><sp/><sp/>0x4DB26158,<sp/>0x5005713C,<sp/>0xEDB88320,<sp/>0xF00F9344,<sp/>0xD6D6A3E8,<sp/>0xCB61B38C,</highlight></codeline>
<codeline lineno="764"><highlight class="normal"><sp/><sp/><sp/><sp/>0x9B64C2B0,<sp/>0x86D3D2D4,<sp/>0xA00AE278,<sp/>0xBDBDF21C</highlight></codeline>
<codeline lineno="765"><highlight class="normal">};</highlight></codeline>
<codeline lineno="766"><highlight class="normal"></highlight></codeline>
<codeline lineno="778"><highlight class="normal"><ref refid="n__request_8c_1af118c2aba9040de625bebcf41c49e571" kindref="member">NOTE_C_STATIC</ref><sp/>int32_t<sp/>crc32(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal">*<sp/>data,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>length)</highlight></codeline>
<codeline lineno="779"><highlight class="normal">{</highlight></codeline>
<codeline lineno="780"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>previousCrc32<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="781"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>crc<sp/>=<sp/>~previousCrc32;</highlight></codeline>
<codeline lineno="782"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>current<sp/>=<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*)<sp/>data;</highlight></codeline>
<codeline lineno="783"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(length--)<sp/>{</highlight></codeline>
<codeline lineno="784"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>crc<sp/>=<sp/>lut[(crc<sp/>^<sp/><sp/>*current<sp/><sp/><sp/><sp/><sp/><sp/>)<sp/>&amp;<sp/>0x0F]<sp/>^<sp/>(crc<sp/>&gt;&gt;<sp/>4);</highlight></codeline>
<codeline lineno="785"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>crc<sp/>=<sp/>lut[(crc<sp/>^<sp/>(*current<sp/>&gt;&gt;<sp/>4))<sp/>&amp;<sp/>0x0F]<sp/>^<sp/>(crc<sp/>&gt;&gt;<sp/>4);</highlight></codeline>
<codeline lineno="786"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>current++;</highlight></codeline>
<codeline lineno="787"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="788"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>~crc;</highlight></codeline>
<codeline lineno="789"><highlight class="normal">}</highlight></codeline>
<codeline lineno="790"><highlight class="normal"></highlight></codeline>
<codeline lineno="804"><highlight class="normal"><ref refid="n__request_8c_1af118c2aba9040de625bebcf41c49e571" kindref="member">NOTE_C_STATIC</ref><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*crcAdd(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*json,<sp/>uint16_t<sp/>seqno)</highlight></codeline>
<codeline lineno="805"><highlight class="normal">{</highlight></codeline>
<codeline lineno="806"><highlight class="normal"></highlight></codeline>
<codeline lineno="807"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Allocate<sp/>a<sp/>block<sp/>the<sp/>size<sp/>of<sp/>the<sp/>input<sp/>json<sp/>plus<sp/>the<sp/>size<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="808"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>field<sp/>to<sp/>be<sp/>added.<sp/><sp/>Note<sp/>that<sp/>the<sp/>input<sp/>JSON<sp/>ends<sp/>in<sp/>&apos;&quot;}&apos;<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="809"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>will<sp/>be<sp/>replaced<sp/>with<sp/>a<sp/>combination<sp/>of<sp/>4<sp/>hex<sp/>digits<sp/>of<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="810"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>seqno<sp/>plus<sp/>8<sp/>hex<sp/>digits<sp/>of<sp/>the<sp/>CRC32,<sp/>and<sp/>the<sp/>&apos;}&apos;<sp/>will<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="811"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transformed<sp/>into<sp/>&apos;,&quot;crc&quot;:&quot;SSSS:CCCCCCCC&quot;}&apos;<sp/>where<sp/>SSSS<sp/>is<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="812"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>seqno<sp/>and<sp/>CCCCCCCC<sp/>is<sp/>the<sp/>crc32.<sp/><sp/>Note<sp/>that<sp/>the<sp/>comma<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="813"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>replaced<sp/>with<sp/>a<sp/>space<sp/>if<sp/>the<sp/>input<sp/>json<sp/>doesn&apos;t<sp/>contain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="814"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>any<sp/>fields,<sp/>so<sp/>that<sp/>we<sp/>always<sp/>return<sp/>compliant<sp/>JSON.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="815"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>jsonLen<sp/>=<sp/>strlen(json);</highlight></codeline>
<codeline lineno="816"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Minimum<sp/>JSON<sp/>is<sp/>&quot;{}&quot;<sp/>and<sp/>must<sp/>end<sp/>with<sp/>a<sp/>closing<sp/>&quot;}&quot;.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="817"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(jsonLen<sp/>&lt;<sp/>2<sp/>||<sp/>json[jsonLen-1]<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="819"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="820"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*newJson<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)<sp/>_Malloc(jsonLen+<ref refid="n__request_8c_1a8334a93acebb34e7bc188f767dc42f90" kindref="member">CRC_FIELD_LENGTH</ref>+1);</highlight></codeline>
<codeline lineno="821"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(newJson<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="823"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="824"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>isEmptyObject<sp/>=<sp/>(memchr(json,<sp/></highlight><highlight class="charliteral">&apos;:&apos;</highlight><highlight class="normal">,<sp/>jsonLen)<sp/>==<sp/>NULL);</highlight></codeline>
<codeline lineno="825"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>newJsonLen<sp/>=<sp/>jsonLen-1;</highlight></codeline>
<codeline lineno="826"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(newJson,<sp/>json,<sp/>newJsonLen);</highlight></codeline>
<codeline lineno="827"><highlight class="normal"><sp/><sp/><sp/><sp/>newJson[newJsonLen++]<sp/>=<sp/>(isEmptyObject<sp/>?<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="charliteral">&apos;,&apos;</highlight><highlight class="normal">);<sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Replace<sp/>}</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="828"><highlight class="normal"><sp/><sp/><sp/><sp/>newJson[newJsonLen++]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>+1</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="829"><highlight class="normal"><sp/><sp/><sp/><sp/>newJson[newJsonLen++]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;c&apos;</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>+2</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="830"><highlight class="normal"><sp/><sp/><sp/><sp/>newJson[newJsonLen++]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;r&apos;</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>+3</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="831"><highlight class="normal"><sp/><sp/><sp/><sp/>newJson[newJsonLen++]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;c&apos;</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>+4</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="832"><highlight class="normal"><sp/><sp/><sp/><sp/>newJson[newJsonLen++]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>+5</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="833"><highlight class="normal"><sp/><sp/><sp/><sp/>newJson[newJsonLen++]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;:&apos;</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>+6</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="834"><highlight class="normal"><sp/><sp/><sp/><sp/>newJson[newJsonLen++]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>+7</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="835"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="n__cjson_8c_1a745406e6582e9e9cd4bc4411d0f91b86" kindref="member">n_htoa16</ref>(seqno,<sp/>(uint8_t<sp/>*)<sp/>&amp;newJson[newJsonLen]);</highlight></codeline>
<codeline lineno="836"><highlight class="normal"><sp/><sp/><sp/><sp/>newJsonLen<sp/>+=<sp/>4;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>+11</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="837"><highlight class="normal"><sp/><sp/><sp/><sp/>newJson[newJsonLen++]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;:&apos;</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>+12</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="838"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="n__hooks_8c_1aac33ee334208aaa53da33809889f0abe" kindref="member">n_htoa32</ref>(crc32(json,<sp/>jsonLen),<sp/>&amp;newJson[newJsonLen]);</highlight></codeline>
<codeline lineno="839"><highlight class="normal"><sp/><sp/><sp/><sp/>newJsonLen<sp/>+=<sp/>8;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>+20</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="840"><highlight class="normal"><sp/><sp/><sp/><sp/>newJson[newJsonLen++]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>+21</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="841"><highlight class="normal"><sp/><sp/><sp/><sp/>newJson[newJsonLen++]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>+22<sp/>==<sp/>CRC_FIELD_LENGTH</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="842"><highlight class="normal"><sp/><sp/><sp/><sp/>newJson[newJsonLen]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>null-terminated<sp/>as<sp/>it<sp/>came<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="843"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>newJson;</highlight></codeline>
<codeline lineno="844"><highlight class="normal">}</highlight></codeline>
<codeline lineno="845"><highlight class="normal"></highlight></codeline>
<codeline lineno="862"><highlight class="normal"><ref refid="n__request_8c_1af118c2aba9040de625bebcf41c49e571" kindref="member">NOTE_C_STATIC</ref><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>crcError(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*json,<sp/>uint16_t<sp/>shouldBeSeqno)</highlight></codeline>
<codeline lineno="863"><highlight class="normal">{</highlight></codeline>
<codeline lineno="864"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Strip<sp/>off<sp/>any<sp/>crlf<sp/>for<sp/>crc<sp/>calculation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="865"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>jsonLen<sp/>=<sp/>strlen(json);</highlight></codeline>
<codeline lineno="866"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(jsonLen<sp/>&gt;<sp/>0<sp/>&amp;&amp;<sp/>json[jsonLen-1]<sp/>&lt;=<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>jsonLen--;</highlight></codeline>
<codeline lineno="868"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="869"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Minimum<sp/>valid<sp/>JSON<sp/>is<sp/>&quot;{}&quot;<sp/>(2<sp/>bytes)<sp/>and<sp/>must<sp/>end<sp/>with<sp/>a<sp/>closing<sp/>&quot;}&quot;.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="870"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(jsonLen<sp/>&lt;<sp/><ref refid="n__request_8c_1a8334a93acebb34e7bc188f767dc42f90" kindref="member">CRC_FIELD_LENGTH</ref>+2<sp/>||<sp/>json[jsonLen-1]<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="872"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="873"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>See<sp/>if<sp/>it<sp/>has<sp/>a<sp/>compliant<sp/>CRC<sp/>field</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="874"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>fieldOffset<sp/>=<sp/>((jsonLen-1)<sp/>-<sp/><ref refid="n__request_8c_1a8334a93acebb34e7bc188f767dc42f90" kindref="member">CRC_FIELD_LENGTH</ref>);</highlight></codeline>
<codeline lineno="875"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(memcmp(&amp;json[fieldOffset+<ref refid="n__request_8c_1a370d78366b4c13731108b1afd745b4ce" kindref="member">CRC_FIELD_NAME_OFFSET</ref>],<sp/><ref refid="n__request_8c_1ac5f2372cc25a915c8dccd2924c7c6f19" kindref="member">CRC_FIELD_NAME_TEST</ref>,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="n__request_8c_1ac5f2372cc25a915c8dccd2924c7c6f19" kindref="member">CRC_FIELD_NAME_TEST</ref>)-1)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="876"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we&apos;ve<sp/>seen<sp/>a<sp/>CRC<sp/>before,<sp/>we<sp/>should<sp/>see<sp/>one<sp/>every<sp/>time</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="877"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>notecardSupportsCrc<sp/>?<sp/>true<sp/>:<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="878"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="879"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>get<sp/>here,<sp/>we&apos;ve<sp/>seen<sp/>at<sp/>least<sp/>one<sp/>CRC<sp/>from<sp/>the<sp/>Notecard,<sp/>so<sp/>we<sp/>should<sp/>expect<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="880"><highlight class="normal"><sp/><sp/><sp/><sp/>notecardSupportsCrc<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="881"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/>&amp;json[fieldOffset<sp/>+<sp/><ref refid="n__request_8c_1a370d78366b4c13731108b1afd745b4ce" kindref="member">CRC_FIELD_NAME_OFFSET</ref><sp/>+<sp/>(</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="n__request_8c_1ac5f2372cc25a915c8dccd2924c7c6f19" kindref="member">CRC_FIELD_NAME_TEST</ref>)-1)];</highlight></codeline>
<codeline lineno="882"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>actualSeqno<sp/>=<sp/>(uint16_t)<sp/><ref refid="n__request_8c_1a56c6c634ffc5ccaa04faf0875c0fe10e" kindref="member">n_atoh</ref>(p,<sp/>4);</highlight></codeline>
<codeline lineno="883"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>actualCrc32<sp/>=<sp/>(uint32_t)<sp/><ref refid="n__request_8c_1a56c6c634ffc5ccaa04faf0875c0fe10e" kindref="member">n_atoh</ref>(p+5,<sp/>8);</highlight></codeline>
<codeline lineno="884"><highlight class="normal"><sp/><sp/><sp/><sp/>json[fieldOffset++]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="885"><highlight class="normal"><sp/><sp/><sp/><sp/>json[fieldOffset]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="886"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>shouldBeCrc32<sp/>=<sp/>crc32(json,<sp/>fieldOffset);</highlight></codeline>
<codeline lineno="887"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(shouldBeSeqno<sp/>!=<sp/>actualSeqno<sp/>||<sp/>shouldBeCrc32<sp/>!=<sp/>actualCrc32);</highlight></codeline>
<codeline lineno="888"><highlight class="normal">}</highlight></codeline>
<codeline lineno="889"><highlight class="normal"></highlight></codeline>
<codeline lineno="890"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/></highlight><highlight class="comment">//<sp/>!NOTE_LOWMEM</highlight><highlight class="normal"></highlight></codeline>
    </programlisting>
    <location file="/home/runner/work/note-c/note-c/n_request.c"/>
  </compounddef>
</doxygen>
